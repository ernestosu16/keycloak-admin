image: registry.gitlab.com/scito/keycloak-admin:latest

services:
  - name: selenium/standalone-chrome-debug
    alias: selenium
    entrypoint: ["/bin/sh", "-c", "while [ ! -f /$CI_PROJECT_DIR/hosts ]; do sleep 1; done && cat /$CI_PROJECT_DIR/hosts > /etc/hosts && /docker-entrypoint.sh foreground"]
  - name: jboss/keycloak
    alias: keycloak
    entrypoint: ["/bin/sh", "-c", "while [ ! -f /$CI_PROJECT_DIR/hosts ]; do sleep 1; done && cat /$CI_PROJECT_DIR/hosts > /etc/hosts && /docker-entrypoint.sh foreground"]

before_script:
  - cp /etc/hosts "${CI_PROJECT_DIR}/"

variables:
  DB_VENDOR: h2
  KEYCLOAK_USER: admin
  KEYCLOAK_PASSWORD: secret

stages:
  - build
  - test
  - deploy

.change_file_permissions: &change_file_permissions |
  find . -type f -not -path "./vendor/*" -exec chmod 664 {} \;
  find . -type d -not -path "./vendor/*" -exec chmod 775 {} \;

composer:
  stage: build
  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - vendor/
  script:
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts --dev
  artifacts:
    expire_in: 1 month
    paths:
      - vendor/

phpunit:
  stage: test
  dependencies:
    - composer
  script:
    - vendor/phpunit/phpunit/phpunit --coverage-text --colors=never
  artifacts:
    paths:
      - ./tests/Browser/screenshots
    expire_in: 7 days
    when: always

codestyle:
  stage: test
  dependencies:
    - composer
  allow_failure: true
  script:
    - vendor/squizlabs/php_codesniffer/bin/phpcs --standard=PSR2 --extensions=php src